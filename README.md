# fMRIPrepCleanup

## Background

fMRIPrep (https://fmriprep.org) is an optimised fMRI preprocessing pipeline that combines best practice tools from a number of sources. This includes the generation of a large number of files, including those produced as preprocessed output that will be used in subsequent analysis, output files that could be used by the researcher but in practice may never be used, and working directory files which are temporary in nature and are very unlikely to serve any practical use. In some cases, 95% of the file size generated by fMRIPrep could be constituted as 'junk' (see below).

Severs use energy not only to process data, but also to store it. Additionally, filling servers with data increases the need to produce and purchase additional hardware to accomodate new projects. In both of these ways, the accumulation of unneeded 'junk' data contributes to the carbon footprint of research computing.

## Usage

As such, we provide here a script that can be used to automatically identify and delete junk files produced by fMRIPrep, used as follows:

```
fMRIPrepCleanup.py path/to/fMRIPrep/directory/
```

This script was written under the assumption that all files generated by fMRIPrep (including output files, log files, and working directory files) that the user might want tidied up are contained somewhere within this directory. However, the script does not rely on any particular file structure or naming convention. Depending on how you have structured your output folders, this could be run at the level of one participant or a full sample. This script works by deleting all files that do not contain specific strings in their name.

**PLEASE NOTE: The files targeted here for retention and deletion are based on those useful to the authors of this script given our research needs. In its current form, this script will delete fMRIPrep output files that other researchers may have good theoretical motivations to retain, such as those generated by FreeSurfer surface reconstruction. As such, researchers should make sure they fully understand the execution of this code before using it on their data, and update it as necessary. Without this, one may risk irrevocably deleting important data. Improper use of this script could be particularly catastrophic if pointed at a directory that contains files other than those generated by fMRIPrep, these would also be deleted. We recommend testing this script on a copy of one subject's preprocessed data before using it on the full sample/original data.**

Strings currently flagged for retention (with rationale for each):

- '*preproc*': Targets any preprocessed functional and anatomical files generated by fMRIPrep, in each output space generated.
- '*brain_mask*': Targets the brain 'mask' generated by fMRIPrep that accompanies preprocessed functional and anatomical output files.
- '*confounds*': Targets the confounds TSV file generated for each BOLD run, as this data is often used in subsequent analysis steps.
- '*html*': Targets the final output report generated by fMRIPrep for each subject, as well as some of the 'figures' used to populate it.
- '*svg*': Targets the remaining 'figures' used to populate the output report for each subject.
- '*emissions*': Targets the estimated carbon emissions output file generated by CodeCarbon (https://codecarbon.io; if toggled on when running fMRIPrep using the 'track-carbon' flag, which we recommend for monitoring purposes).

Any folders that are themselves totally empty following file deletion will also be deleted, to provide a cleaner view of what remains in your fMRIPrep directory. Note that some non-target files do slip through the cracks according to the inclusion criteria specified above. As such, the following are specifically targeted for deletion:

- '*index.html*': A non-subject-specific working directory file that will not be needed.
- '*single_subject_{subject number}_wf*': Subject specific working directory folders that would otherwise remain given the presence of HTML files as well as several containing the string 'preproc'.
- '*fsaverage*': A non-subject-specific FreeSurfer output directory folder that would otherwise remain given the presence of two files containing the string 'preproc'.

Upon executing the script, users will be warned that files within the specified directory are about to be deleted. The user can proceed with 'Y', or abort with 'N'. If the specified fMRIPrep directory does not exist or is not found, the user will be warned, and the script will exit.

## Example output

Below is an example file tree of **ALL** files that would remain for a single subject using the current version of this script, where all working directory, output, and log files were located in the directory targeted. This data was derived from the default fMRIPrep pipeline, with no extra output spaces specified.

* derivatives /
  * sub-001.html
  * logs /
    * CITATION.html
    * emissions.csv
  * sub-001 /
    * anat /
      * sub-001_desc-brain_mask.json
      * sub-001_desc-brain_mask.nii.gz
      * sub-001_desc-preproc_T1w.json
      * sub-001_desc-preproc_T1w.nii.gz
      * sub-001_space-MNI152NLin6Asym_res-2_desc-brain_mask.json
      * sub-001_space-MNI152NLin6Asym_res-2_desc-brain_mask.nii.gz
      * sub-001_space-MNI152NLin6Asym_res-2_desc-preproc_T1w.json
      * sub-001_space-MNI152NLin6Asym_res-2_desc-preproc_T1w.nii.gz
    * figures /
      * sub-001_desc-about_T1w.html
      * sub-001_desc-conform_T1w.html
      * sub-001_desc-reconall_T1w.svg
      * sub-001_desc-summary_T1w.html
      * sub-001_dseg.svg
      * sub-001_space-MNI152NLin2009cAsym_T1w.svg
      * sub-001_space-MNI152NLin6Asym_T1w.svg
      * sub-001_task-stopsignal_desc-bbregister_bold.svg
      * sub-001_task-stopsignal_desc-carpetplot_bold.svg
      * sub-001_task-stopsignal_desc-compcorvar_bold.svg
      * sub-001_task-stopsignal_desc-confoundcorr_bold.svg
      * sub-001_task-stopsignal_desc-rois_bold.svg
      * sub-001_task-stopsignal_desc-summary_bold.html
      * sub-001_task-stopsignal_desc-validation_bold.html
    * func /
      * sub-001_task-stopsignal_desc-confounds_timeseries.json
      * sub-001_task-stopsignal_desc-confounds_timeseries.tsv
      * sub-001_task-stopsignal_space-MNI152NLin6Asym_res-2_desc-brain_mask.json
      * sub-001_task-stopsignal_space-MNI152NLin6Asym_res-2_desc-brain_mask.nii.gz
      * sub-001_task-stopsignal_space-MNI152NLin6Asym_res-2_desc-preproc_bold.json
      * sub-001_task-stopsignal_space-MNI152NLin6Asym_res-2_desc-preproc_bold.nii.gz

  For context, the full size of files for this subject prior to deletion was 5.8 GB. Following the clean-up, this number dropped to 285 MB, a 95% reduction in size.
